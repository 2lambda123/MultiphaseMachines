#include "transformation.h"
#include "hpd_control.h"
#include "math.h"

void calc_CosSin(double theta[static Qs/2], double phiAlignment[static Qs/2], struct dq_frame CosSin[static Qs/2])
{
	//---------------------------------
	// Description
	//---------------------------------
	/* 
        Calculates the Cos and Sin values
		for the park transformation
    */
    for(int i = 0; i < Qs/2; i++)
    {
        CosSin[i].d = cos(theta[i]+phiAlignment[i]); 
        CosSin[i].q = sin(theta[i]+phiAlignment[i]); 
    }
}

void clarke_trans(double input_123[static Qs], struct ab_frame output_alphabeta[static Qs/2])
{
	//---------------------------------
	// Description
	//---------------------------------
	/* 
        Calculates the clarke transformation
    */
    for(int i = 0; i < Qs-1; i+=2)
    {
        for(int j = 0; j < Qs; j++)
        {
            output_alphabeta[i].a += input_123[j]*clarkeMatrix[i][j]*2/Qs;  
            output_alphabeta[i+1].b += input_123[j]*clarkeMatrix[i+1][j]*2/Qs;
        }
    }
}

void inv_clarke_trans(struct ab_frame input_ab[static Qs/2], double output_123[static Qs])
{
	//---------------------------------
	// Description
	//---------------------------------
	/* 
        Calculates the inverse clarke transformation.
		This is done using the property that the transpose
		of the clarkeMatrix is its own inverse.
    */
    for(int i = 0; i < Qs-1; i+=2)
    {
        for(int j = 0; j < Qs; j++)
        {
            output_123[i] += input_ab[j].a*clarkeMatrix[j][i]*2/Qs;  
            output_123[i+1] += input_ab[j].b*clarkeMatrix[j+1][i]*2/Qs;
        }
    }
}

void park_trans(struct ab_frame input_alphabeta[static Qs/2], struct dq_frame CosSin[static Qs/2], struct dq_frame output_dq[static Qs/2])
{
	//---------------------------------
	// Description
	//---------------------------------
	/* 
        Calculates the park transformation
    */
    for(int i = 0; i < Qs/2; i++)
    {
        output_dq[i].d = (input_alphabeta[i].a*CosSin[i].d) + (input_alphabeta[i].b*CosSin[i].q);
        output_dq[i].q = (-input_alphabeta[i].a*CosSin[i].q) + (input_alphabeta[i].b*CosSin[i].d);
    }
}

void inv_park_trans(struct dq_frame input_dq[static Qs/2], struct dq_frame CosSin[static Qs/2], struct ab_frame output_ab[static Qs/2])
{
	//---------------------------------
	// Description
	//---------------------------------
	/* 
        Calculates the inverse park transformation
    */
    for(int i = 0; i < Qs/2; i++)
    {
        output_ab[i].a = (input_dq[i].d*CosSin[i].d) + (-input_dq[i].q*CosSin[i].q);
        output_ab[i].b = (input_dq[i].q*CosSin[i].d) + (input_dq[i].d*CosSin[i].q);
    }
}

//---------------------------------
// Initialize the clark matrix
//---------------------------------
const double clarkeMatrix[Qs][Qs] =
{
		{1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0.984807753012208,0.17364817766693,0.939692620785908,0.342020143325669,0.866025403784439,0.5,0.766044443118978,0.642787609686539,0.642787609686539,0.766044443118978,0.5,0.866025403784439,0.342020143325669,0.939692620785908,0.17364817766693,0.984807753012208,0,1,-0.17364817766693,0.984807753012208,-0.342020143325669,0.939692620785908,-0.5,0.866025403784439,-0.642787609686539,0.766044443118978,-0.766044443118978,0.642787609686539,-0.866025403784439,0.5,-0.939692620785908,0.342020143325669,-0.984807753012208,0.173648177666931,-1,0},
		{0.939692620785908,0.342020143325669,0.766044443118978,0.642787609686539,0.5,0.866025403784439,0.17364817766693,0.984807753012208,-0.17364817766693,0.984807753012208,-0.5,0.866025403784439,-0.766044443118978,0.642787609686539,-0.939692620785908,0.342020143325669,-1,0,-0.939692620785908,-0.342020143325669,-0.766044443118978,-0.642787609686539,-0.5,-0.866025403784438,-0.17364817766693,-0.984807753012208,0.17364817766693,-0.984807753012208,0.5,-0.866025403784439,0.766044443118978,-0.64278760968654,0.939692620785908,-0.342020143325669,1,0},
		{0.866025403784439,0.5,0.5,0.866025403784439,0,1,-0.5,0.866025403784439,-0.866025403784439,0.5,-1,0,-0.866025403784439,-0.5,-0.5,-0.866025403784438,0,-1,0.5,-0.866025403784439,0.866025403784438,-0.5,1,0,0.866025403784439,0.5,0.500000000000001,0.866025403784438,0,1,-0.499999999999999,0.866025403784439,-0.866025403784439,0.5,-1,0},
		{0.766044443118978,0.642787609686539,0.17364817766693,0.984807753012208,-0.5,0.866025403784439,-0.939692620785908,0.342020143325669,-0.939692620785908,-0.342020143325669,-0.5,-0.866025403784438,0.17364817766693,-0.984807753012208,0.766044443118978,-0.64278760968654,1,0,0.766044443118978,0.642787609686539,0.17364817766693,0.984807753012208,-0.499999999999999,0.866025403784439,-0.939692620785908,0.342020143325669,-0.939692620785909,-0.342020143325668,-0.5,-0.866025403784439,0.17364817766693,-0.984807753012208,0.766044443118977,-0.64278760968654,1,0},
		{0.642787609686539,0.766044443118978,-0.17364817766693,0.984807753012208,-0.866025403784439,0.5,-0.939692620785908,-0.342020143325669,-0.342020143325669,-0.939692620785908,0.5,-0.866025403784439,0.984807753012208,-0.17364817766693,0.766044443118978,0.642787609686539,0,1,-0.766044443118977,0.64278760968654,-0.984807753012208,-0.17364817766693,-0.5,-0.866025403784439,0.342020143325668,-0.939692620785909,0.939692620785908,-0.342020143325669,0.866025403784439,0.499999999999999,0.173648177666931,0.984807753012208,-0.642787609686538,0.766044443118979,-1,0},
		{0.5,0.866025403784439,-0.5,0.866025403784439,-1,0,-0.5,-0.866025403784438,0.5,-0.866025403784439,1,0,0.500000000000001,0.866025403784438,-0.499999999999999,0.866025403784439,-1,0,-0.5,-0.866025403784439,0.499999999999999,-0.866025403784439,1,0,0.5,0.866025403784439,-0.499999999999999,0.866025403784439,-1,0,-0.500000000000002,-0.866025403784438,0.5,-0.866025403784438,1,0},
		{0.342020143325669,0.939692620785908,-0.766044443118978,0.642787609686539,-0.866025403784439,-0.5,0.17364817766693,-0.984807753012208,0.984807753012208,-0.17364817766693,0.500000000000001,0.866025403784438,-0.642787609686538,0.766044443118979,-0.939692620785909,-0.342020143325668,0,-1,0.939692620785908,-0.342020143325669,0.64278760968654,0.766044443118977,-0.499999999999999,0.866025403784439,-0.984807753012208,-0.17364817766693,-0.173648177666933,-0.984807753012208,0.866025403784439,-0.5,0.766044443118979,0.642787609686538,-0.342020143325669,0.939692620785908,-1,0},
		{0.17364817766693,0.984807753012208,-0.939692620785908,0.342020143325669,-0.5,-0.866025403784438,0.766044443118978,-0.64278760968654,0.766044443118978,0.642787609686539,-0.499999999999999,0.866025403784439,-0.939692620785909,-0.342020143325668,0.17364817766693,-0.984807753012208,1,0,0.173648177666931,0.984807753012208,-0.939692620785908,0.342020143325669,-0.500000000000002,-0.866025403784438,0.766044443118978,-0.642787609686539,0.766044443118979,0.642787609686538,-0.5,0.866025403784438,-0.939692620785909,-0.342020143325668,0.173648177666928,-0.984807753012209,1,0},
		{0,1,-1,0,0,-1,1,0,0,1,-1,0,0,-1,1,0,0,1,-1,0,0,-1,1,0,0,1,-1,0,0,-1,1,0,0,1,-1,0},
		{-0.17364817766693,0.984807753012208,-0.939692620785908,-0.342020143325669,0.5,-0.866025403784439,0.766044443118978,0.642787609686539,-0.766044443118977,0.64278760968654,-0.5,-0.866025403784439,0.939692620785908,-0.342020143325669,0.173648177666931,0.984807753012208,-1,0,0.173648177666928,-0.984807753012209,0.939692620785909,0.342020143325668,-0.5,0.866025403784438,-0.766044443118979,-0.642787609686538,0.766044443118978,-0.642787609686539,0.500000000000002,0.866025403784437,-0.939692620785908,0.342020143325669,-0.173648177666933,-0.984807753012208,1,0},
		{-0.342020143325669,0.939692620785908,-0.766044443118978,-0.642787609686539,0.866025403784438,-0.5,0.17364817766693,0.984807753012208,-0.984807753012208,-0.17364817766693,0.499999999999999,-0.866025403784439,0.64278760968654,0.766044443118977,-0.939692620785908,0.342020143325669,0,-1,0.939692620785909,0.342020143325668,-0.642787609686539,0.766044443118978,-0.500000000000002,-0.866025403784438,0.984807753012208,-0.173648177666931,-0.173648177666927,0.984807753012209,-0.866025403784439,-0.499999999999999,0.766044443118978,-0.64278760968654,0.342020143325668,0.939692620785909,-1,0},
		{-0.5,0.866025403784439,-0.5,-0.866025403784438,1,0,-0.499999999999999,0.866025403784439,-0.5,-0.866025403784439,1,0,-0.499999999999999,0.866025403784439,-0.500000000000002,-0.866025403784438,1,0,-0.5,0.866025403784438,-0.500000000000002,-0.866025403784438,1,0,-0.5,0.866025403784439,-0.500000000000002,-0.866025403784437,1,0,-0.499999999999997,0.86602540378444,-0.499999999999999,-0.866025403784439,1,0},
		{-0.642787609686539,0.766044443118978,-0.17364817766693,-0.984807753012208,0.866025403784439,0.5,-0.939692620785908,0.342020143325669,0.342020143325668,-0.939692620785909,0.5,0.866025403784439,-0.984807753012208,-0.17364817766693,0.766044443118978,-0.642787609686539,0,1,-0.766044443118979,-0.642787609686538,0.984807753012208,-0.173648177666931,-0.5,0.866025403784439,-0.342020143325671,-0.939692620785908,0.939692620785909,0.342020143325667,-0.866025403784438,0.500000000000001,0.17364817766693,-0.984807753012208,0.642787609686538,0.766044443118979,-1,0},
		{-0.766044443118978,0.642787609686539,0.17364817766693,-0.984807753012208,0.500000000000001,0.866025403784438,-0.939692620785909,-0.342020143325668,0.939692620785908,-0.342020143325669,-0.499999999999999,0.866025403784439,-0.173648177666933,-0.984807753012208,0.766044443118979,0.642787609686538,-1,0,0.766044443118978,-0.642787609686539,-0.173648177666927,0.984807753012209,-0.500000000000002,-0.866025403784437,0.939692620785909,0.342020143325667,-0.939692620785907,0.342020143325673,0.5,-0.866025403784439,0.173648177666933,0.984807753012207,-0.766044443118977,-0.64278760968654,1,0},
		{-0.866025403784439,0.5,0.5,-0.866025403784439,0,1,-0.5,-0.866025403784439,0.866025403784439,0.499999999999999,-1,0,0.866025403784439,-0.5,-0.5,0.866025403784438,0,-1,0.500000000000002,0.866025403784437,-0.866025403784439,-0.499999999999999,1,0,-0.866025403784438,0.500000000000001,0.5,-0.866025403784439,0,1,-0.499999999999999,-0.866025403784439,0.866025403784442,0.499999999999995,-1,0},
		{-0.939692620785908,0.342020143325669,0.766044443118978,-0.64278760968654,-0.499999999999999,0.866025403784439,0.17364817766693,-0.984807753012208,0.173648177666931,0.984807753012208,-0.500000000000002,-0.866025403784438,0.766044443118979,0.642787609686538,-0.939692620785909,-0.342020143325668,1,0,-0.939692620785908,0.342020143325669,0.766044443118978,-0.64278760968654,-0.499999999999997,0.86602540378444,0.17364817766693,-0.984807753012208,0.173648177666933,0.984807753012207,-0.499999999999999,-0.866025403784439,0.76604444311898,0.642787609686537,-0.93969262078591,-0.342020143325663,1,0},
		{-0.984807753012208,0.173648177666931,0.939692620785908,-0.342020143325669,-0.866025403784439,0.5,0.766044443118977,-0.64278760968654,-0.642787609686538,0.766044443118979,0.5,-0.866025403784438,-0.342020143325669,0.939692620785908,0.173648177666928,-0.984807753012209,0,1,-0.173648177666933,-0.984807753012208,0.342020143325668,0.939692620785909,-0.499999999999999,-0.866025403784439,0.642787609686538,0.766044443118979,-0.766044443118977,-0.64278760968654,0.866025403784442,0.499999999999995,-0.93969262078591,-0.342020143325663,0.984807753012209,0.173648177666925,-1,0},
		{-1,0,1,0,-1,0,1,0,-1,0,1,0,-1,0,1,0,-1,0,1,0,-1,0,1,0,-1,0,1,0,-1,0,1,0,-1,0,1,0},
		{-0.984807753012208,-0.17364817766693,0.939692620785909,0.342020143325668,-0.866025403784439,-0.499999999999999,0.766044443118979,0.642787609686538,-0.642787609686541,-0.766044443118977,0.500000000000002,0.866025403784438,-0.342020143325671,-0.939692620785908,0.173648177666933,0.984807753012208,0,-1,-0.173648177666927,0.984807753012209,0.342020143325665,-0.93969262078591,-0.499999999999997,0.866025403784441,0.642787609686536,-0.766044443118981,-0.766044443118975,0.642787609686543,0.866025403784436,-0.500000000000004,-0.939692620785907,0.342020143325674,0.984807753012207,-0.173648177666936,-1,0},
		{-0.939692620785908,-0.342020143325669,0.766044443118978,0.642787609686539,-0.5,-0.866025403784439,0.173648177666931,0.984807753012208,0.173648177666928,-0.984807753012209,-0.5,0.866025403784438,0.766044443118978,-0.642787609686539,-0.939692620785908,0.342020143325669,1,0,-0.93969262078591,-0.342020143325664,0.766044443118979,0.642787609686538,-0.499999999999999,-0.866025403784439,0.173648177666934,0.984807753012207,0.17364817766693,-0.984807753012208,-0.499999999999996,0.866025403784441,0.766044443118977,-0.64278760968654,-0.939692620785907,0.342020143325674,1,0},
		{-0.866025403784439,-0.5,0.500000000000001,0.866025403784438,0,-1,-0.499999999999999,0.866025403784439,0.866025403784439,-0.5,-1,0,0.866025403784439,0.499999999999999,-0.500000000000002,-0.866025403784437,0,1,0.5,-0.866025403784439,-0.866025403784438,0.500000000000001,1,0,-0.86602540378444,-0.499999999999998,0.500000000000003,0.866025403784437,0,-1,-0.499999999999996,0.866025403784441,0.866025403784436,-0.500000000000005,-1,0},
		{-0.766044443118978,-0.642787609686539,0.17364817766693,0.984807753012208,0.499999999999999,-0.866025403784439,-0.939692620785908,0.342020143325669,0.939692620785909,0.342020143325668,-0.500000000000002,-0.866025403784438,-0.173648177666927,0.984807753012209,0.766044443118978,-0.64278760968654,-1,0,0.766044443118979,0.642787609686538,-0.17364817766693,-0.984807753012208,-0.499999999999996,0.866025403784441,0.939692620785908,-0.34202014332567,-0.93969262078591,-0.342020143325663,0.500000000000003,0.866025403784437,0.17364817766693,-0.984807753012208,-0.766044443118979,0.642787609686538,1,0},
		{-0.642787609686539,-0.766044443118978,-0.17364817766693,0.984807753012208,0.866025403784439,-0.5,-0.939692620785909,-0.342020143325668,0.342020143325671,0.939692620785908,0.5,-0.866025403784438,-0.984807753012208,0.173648177666931,0.766044443118979,0.642787609686538,0,-1,-0.766044443118975,0.642787609686543,0.984807753012209,0.173648177666925,-0.5,-0.866025403784439,-0.342020143325668,0.939692620785909,0.939692620785908,-0.34202014332567,-0.86602540378444,-0.499999999999997,0.173648177666934,0.984807753012207,0.642787609686535,-0.766044443118981,-1,0},
		{-0.5,-0.866025403784438,-0.499999999999999,0.866025403784439,1,0,-0.500000000000002,-0.866025403784438,-0.5,0.866025403784438,1,0,-0.500000000000002,-0.866025403784437,-0.499999999999997,0.86602540378444,1,0,-0.499999999999999,-0.866025403784439,-0.499999999999996,0.866025403784441,1,0,-0.5,-0.866025403784439,-0.499999999999996,0.866025403784441,1,0,-0.500000000000006,-0.866025403784435,-0.500000000000002,0.866025403784438,1,0},
		{-0.342020143325669,-0.939692620785908,-0.766044443118977,0.64278760968654,0.866025403784439,0.499999999999999,0.173648177666928,-0.984807753012209,-0.984807753012208,0.173648177666931,0.500000000000002,0.866025403784437,0.642787609686539,-0.766044443118978,-0.93969262078591,-0.342020143325664,0,1,0.939692620785908,-0.34202014332567,-0.642787609686541,-0.766044443118976,-0.499999999999996,0.866025403784441,0.984807753012209,0.173648177666924,-0.173648177666931,-0.984807753012208,-0.866025403784438,0.500000000000002,0.766044443118985,0.642787609686531,0.342020143325664,-0.93969262078591,-1,0},
		{-0.17364817766693,-0.984807753012208,-0.939692620785908,0.342020143325669,0.5,0.866025403784439,0.766044443118978,-0.642787609686539,-0.766044443118979,-0.642787609686538,-0.5,0.866025403784439,0.939692620785909,0.342020143325667,0.17364817766693,-0.984807753012208,-1,0,0.173648177666934,0.984807753012207,0.939692620785908,-0.34202014332567,-0.5,-0.866025403784439,-0.766044443118975,0.642787609686543,0.76604444311898,0.642787609686537,0.499999999999999,-0.866025403784439,-0.939692620785908,-0.342020143325669,-0.173648177666932,0.984807753012208,1,0},
		{0,-1,-1,0,0,1,1,0,0,-1,-1,0,0,1,1,0,0,-1,-1,0,0,1,1,0,0,-1,-1,0,0,1,1,0,0,-1,-1,0},
		{0.17364817766693,-0.984807753012208,-0.939692620785909,-0.342020143325668,-0.499999999999999,0.866025403784439,0.766044443118979,0.642787609686538,0.766044443118978,-0.642787609686539,-0.500000000000002,-0.866025403784437,-0.939692620785907,0.342020143325673,0.173648177666933,0.984807753012207,1,0,0.17364817766693,-0.984807753012208,-0.93969262078591,-0.342020143325663,-0.499999999999996,0.866025403784441,0.76604444311898,0.642787609686537,0.766044443118972,-0.642787609686546,-0.5,-0.866025403784438,-0.939692620785906,0.342020143325675,0.173648177666928,0.984807753012208,1,0},
		{0.342020143325668,-0.939692620785909,-0.766044443118979,-0.642787609686538,-0.866025403784439,0.5,0.173648177666933,0.984807753012208,0.984807753012208,0.173648177666929,0.5,-0.866025403784439,-0.642787609686541,-0.766044443118977,-0.939692620785907,0.342020143325673,0,1,0.939692620785909,0.342020143325666,0.642787609686536,-0.766044443118981,-0.5,-0.866025403784439,-0.984807753012206,0.17364817766694,-0.173648177666926,0.984807753012209,0.866025403784439,0.5,0.766044443118972,-0.642787609686547,-0.342020143325673,-0.939692620785907,-1,0},
		{0.5,-0.866025403784439,-0.5,-0.866025403784439,-1,0,-0.5,0.866025403784438,0.500000000000002,0.866025403784437,1,0,0.5,-0.866025403784439,-0.499999999999999,-0.866025403784439,-1,0,-0.499999999999996,0.866025403784441,0.500000000000003,0.866025403784437,1,0,0.499999999999999,-0.866025403784439,-0.5,-0.866025403784438,-1,0,-0.500000000000001,0.866025403784438,0.50000000000001,0.866025403784433,1,0},
		{0.642787609686539,-0.766044443118978,-0.173648177666931,-0.984807753012208,-0.866025403784439,-0.499999999999999,-0.939692620785908,0.342020143325669,-0.342020143325666,0.93969262078591,0.500000000000002,0.866025403784437,0.984807753012209,0.173648177666925,0.766044443118977,-0.64278760968654,0,-1,-0.766044443118982,-0.642787609686534,-0.984807753012208,0.173648177666932,-0.499999999999996,0.866025403784441,0.342020143325676,0.939692620785906,0.939692620785912,0.342020143325659,0.866025403784439,-0.499999999999999,0.173648177666929,-0.984807753012208,-0.642787609686543,-0.766044443118975,-1,0},
		{0.766044443118978,-0.64278760968654,0.17364817766693,-0.984807753012208,-0.500000000000002,-0.866025403784438,-0.939692620785909,-0.342020143325668,-0.939692620785908,0.342020143325669,-0.499999999999997,0.86602540378444,0.173648177666933,0.984807753012207,0.76604444311898,0.642787609686537,1,0,0.766044443118977,-0.64278760968654,0.17364817766693,-0.984807753012208,-0.500000000000006,-0.866025403784435,-0.939692620785908,-0.342020143325669,-0.939692620785906,0.342020143325675,-0.500000000000001,0.866025403784438,0.173648177666935,0.984807753012207,0.766044443118985,0.64278760968653,1,0},
		{0.866025403784438,-0.5,0.499999999999999,-0.866025403784439,0,-1,-0.500000000000002,-0.866025403784438,-0.866025403784439,-0.499999999999999,-1,0,-0.866025403784438,0.500000000000001,-0.499999999999996,0.866025403784441,0,1,0.500000000000003,0.866025403784437,0.866025403784442,0.499999999999994,1,0,0.866025403784436,-0.500000000000005,0.499999999999998,-0.86602540378444,0,-1,-0.500000000000007,-0.866025403784434,-0.866025403784441,-0.499999999999996,-1,0},
		{0.939692620785908,-0.342020143325669,0.766044443118977,-0.64278760968654,0.5,-0.866025403784438,0.173648177666928,-0.984807753012209,-0.173648177666933,-0.984807753012208,-0.499999999999999,-0.866025403784439,-0.766044443118977,-0.64278760968654,-0.93969262078591,-0.342020143325663,-1,0,-0.939692620785907,0.342020143325674,-0.766044443118979,0.642787609686538,-0.500000000000002,0.866025403784438,-0.173648177666932,0.984807753012208,0.173648177666928,0.984807753012208,0.50000000000001,0.866025403784433,0.766044443118985,0.64278760968653,0.939692620785912,0.342020143325658,1,0},
		{0.984807753012208,-0.17364817766693,0.939692620785908,-0.342020143325669,0.866025403784439,-0.5,0.766044443118978,-0.642787609686539,0.642787609686539,-0.766044443118978,0.5,-0.866025403784439,0.342020143325665,-0.93969262078591,0.17364817766693,-0.984807753012208,0,-1,-0.173648177666931,-0.984807753012208,-0.342020143325666,-0.939692620785909,-0.5,-0.866025403784438,-0.642787609686542,-0.766044443118975,-0.766044443118983,-0.642787609686533,-0.866025403784444,-0.49999999999999,-0.939692620785909,-0.342020143325668,-0.984807753012209,-0.173648177666926,-1,0}
};																							
